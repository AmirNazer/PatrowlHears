<template>
    <v-card-title primary class="title">
        <v-container class="grey lighten-5">
            <v-row no-gutters> 

                <v-col class="pa-2" md="auto">
                    Vuln ID: PH-{{ this.vuln.id }}
                </v-col>

                <v-col class="pa-2" md="auto">
                    <v-icon
                        color="deep-orange"
                        title="Edit Vulnerability"
                        @click="dialog_edit_vuln=true"
                    >mdi-pencil</v-icon>
                    <v-icon
                        color="deep-orange"
                        title="Download as JSON file"
                        @click="downloadVuln(vuln.id, 'json')"
                    >mdi-download</v-icon>
                    <v-icon
                        color="deep-orange"
                        title="Send vulnerability as email"
                        @click="dialog_send_mail=true"
                    >mdi-email-send-outline</v-icon>
                </v-col>

                <v-col class="pa-2">
                    <v-chip
                        small label outlined 
                        :color="this.getColorChipMonitored"
                        @click="toggleMonitored"
                    >{{this.getTextChipMonitored}}</v-chip>
                </v-col>


            </v-row>
        </v-container>

        <v-dialog 
            v-model="dialog_edit_vuln"
            max-width="600px" 
            v-if="this.showManageMetadataButtons()"
        >
            <DialogVulnAddEdit 
                :vuln="this.vuln"
                action="edit"
            />
        </v-dialog>

        <v-dialog
            v-model="dialog_send_mail"
            max-width="600px" 
        >
            <DialogSendEmail 
                :vuln_id="this.vuln.id"
                v-on="$listeners"
                @CloseDialog="toggleDialogEmail"
            />
        </v-dialog>

    </v-card-title>
</template>

<script>
import Users from "@/common/users";
import Download from "@/common/download";
import DialogVulnAddEdit from '@/components/vulnerability/vulnerabilityDetails/dialog/DialogVulnAddEdit.vue';
import DialogSendEmail from '@/components/vulnerability/vulnerabilityDetails/dialog/DialogSendEmail.vue';

export default {
    mixins: [
        Users, Download
    ],
    data: () =>  ({
        dialog_edit_vuln: false,
        dialog_send_mail: false,
    }),
    components: {
        DialogVulnAddEdit,
        DialogSendEmail
    },
    props: {
        vuln: Object
    },
    computed: {
        getColorChipMonitored() {
            return this.vuln.monitored === true ? 'deep-orange' : 'grey'
        },
        getTextChipMonitored() {
            return this.vuln.monitored === true ? 'Monitored' : 'Not Monitored'
        }
    },
    methods: {
        showManageMetadataButtons() {
            let p = JSON.parse(this.getUserProfile());
            if (p != null && 'manage_metadata' in p){
                return p.manage_metadata;
            } else {
                return true;
            }
        },
        downloadVuln(vuln_id, format="json") {
            this.$api.get('/api/vulns/'+vuln_id+'/export/'+format, {responseType: 'arraybuffer'}).then(res => {
                this.forceFileDownload(res, 'vuln_export_'+vuln_id+'.'+format);
                const snack = {
                    open: true,
                    color: "success",
                    text: "Vulnerability details available."
                };
                this.$emit('OpenSnackBar', snack)
            }).catch(e => {
                const snack = {
                    open: true,
                    color: "error",
                    text: "Unable to download vulnerability details."
                };
                this.$emit('OpenSnackBar', snack)
            });
            this.loading = false;
        },
        toggleMonitored() {
            // save in backend
            let data = {
                'monitored': !this.vuln.monitored,
                'vuln_id': this.vuln.id,
                'organization_id': localStorage.getItem('org_id')
            };
            this.$api.put('/api/vulns/'+this.vuln.id+'/toggle', data).then(res => {
                if (res){
                    this.vuln.monitored = !this.vuln.monitored;
                    // Snack notifications
                    const snack = {
                        open: true,
                        color: 'success',
                        text: 'Vulnerability monitoring successfuly updated.'
                    }
                    this.$emit('OpenSnackBar', snack)
                } else {
                    const snack = {
                        open: true, 
                        color: 'error',
                        text: 'Unable to change the vulnerability monitoring status'
                    }
                    this.$emit('OpenSnackBar', snack)
                }
            }).catch(e => {
                this.loading = false;
                swal.fire({
                    title: 'Error',
                    text: 'Unable to change the vulnerability monitoring status',
                    showConfirmButton: false,
                    showCloseButton: false,
                    timer: 3000
                });
                return;
            });
        },
        toggleDialogEmail(value) {
            this.dialog_send_mail = value
        }
    }
}
</script>